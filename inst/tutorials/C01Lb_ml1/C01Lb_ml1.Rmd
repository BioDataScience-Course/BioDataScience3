---
title: "Machine learning (1)"
author: "Guyliann Engels & Philippe Grosjean"
description: "**SDD III Module 1** Machine learning (1)"
tutorial:
  id: "C01Lb_ml1"
  version: 2.0.0/5
output:
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
BioDataScience3::learnr_setup()
SciViews::R()
library(mlearning)

# exercice preparation --------
read("biometry", package = "BioDataScience") %>.%
  select(., gender, weight, height, wrist) %>.%
  drop_na(.) %->%
  bio

## Preparetrain et test sets
n <- nrow(bio)
n_train <- round(n * 2/3)
set.seed(164)
train <- sample(1:n, n_train)

bio_train <- bio[ train, ]
bio_test <- bio[ -train, ]

## Creation d'un modèle lda
bio_lda <- mlLda(data = bio_train, gender ~ .)

## Confusion 
bio_conf <- confusion(predict(bio_lda, bio_test), bio_test$gender)
conf_tab <- summary(bio_conf)
```

```{r, echo=FALSE}
BioDataScience3::learnr_banner()
```

```{r, context="server"}
BioDataScience3::learnr_server(input, output, session)
```

------------------------------------------------------------------------

## Objectifs

-   Réalisez une analyse discriminante linéaire.

## Création de votre modèle

Vous avez à votre disposition le jeu de données `bio` dont un résumé est proposé ci-dessous.

```{r, echo = TRUE}
skimr::skim(bio)
```

Ce jeu de données est constitué `r ncol(bio)` variables. La variable `gender` est une variable facteur à deux niveaux : `M` (Man), `W` (Woman). Il y a également trois variables numérique qui sont les attributs à utiliser pour la classification supervisée :

-   weight : la masse en kg
-   height : la taille en cm
-   wrist : la circonférence du poignet en mm

Ce tableau est ensuite divisé en un set d'apprentissage `bio_train` et un set de test `bio_test`. Le set d'apprentissage contient 2/3 des observations de départ sélectionnées aléatoirement. Il contient donc `r nrow(bio_train)` lignes. Le set de test `bio_test` en est le complément avec `r nrow(bio_test)` lignes.

L'objectif de ce tutoriel est de vous permettre de découvrir l'analyse discriminante linéaire. En pratique, avant de subdiviser votre tableau de données et de vous lancer dans l'apprentissage de votre modèle, vous devez :

-   visualiser vos données à l'aide de plusieurs graphiques,
-   vérifier et corriger le type de chaque variable (surtout pour les variables facteurs),
-   calculer des variables supplémentaires pertinentes,
-   traiter le problème des valeurs manquantes si votre modèle ne les gère pas,
-   éliminer des variables inutiles (par exemple, le code d'identification d'un individu).

Ces étapes vont faire partie de la nécessaire préparation de vos données avant même de diviser votre tableau en set d'apprentissage et en set de test. Vous devez en être bien conscient. Cependant ici, nous allons aller droit au but et considérer que cela a été fait, mais ne l'oubliez pas plus tard dans vos projets !

Voici la répartition des sexes dans le set d'apprentissage :

```{r, echo=TRUE}
table(bio_train$gender)
```

... et dans le set de test :

```{r}
table(bio_test$gender)
```

Entraînez un modèle de type discriminant linéaire avec le set d'apprentissage. Votre objectif est de prédire la variable `gender` à l'aide des trois variables numériques. Placer ce classifieur dans la variable `bio_lda`.

```{r lda1_h2, exercise = TRUE}
bio_lda <- mlLda(data = ___, ___ ~ ___)
summary(bio_lda)
```

```{r lda1_h2-hint-1}
bio_lda <- mlLda(data = bio_train, ___ ~ ___)
summary(bio_lda)

## Attention, le prochain indice est la solution ##
```

```{r lda1_h2-solution}
## Solution ##
bio_lda <- mlLda(data = bio_train, gender ~ .)
summary(bio_lda)
```

```{r lda1_h2-check}
grade_code("Votre premier modèle LDA. Voyons quoi en faire à présent...")
```

*La formule doit être écrite sous sa forme condensée*

## Performance de votre modèle

Vous devez maintenant tester les performances de votre classifieur. Ne vous trompez pas dans le jeu de données à utiliser `bio_train` ou `bio_test` pour ce faire.

```{r lda2_h2, exercise = TRUE}
bio_pred <- predict(___, ___)
bio_conf <- confusion(___, ___$___)
bio_conf
summary(bio_conf)
```

```{r lda2_h2-hint-1}
bio_pred <- predict(bio_lda, bio_test)
bio_conf <- confusion(bio_pred, ___$___)
bio_conf
summary(bio_conf)

## Attention, le prochain indice est la solution ##
```

```{r lda2_h2-solution}
## Solution ##
bio_pred <- predict(bio_lda, bio_test)
bio_conf <- confusion(bio_pred, bio_test$gender)
bio_conf
summary(bio_conf)
```

```{r lda2_h2-check}
grade_code("Vous venez de réaliser vos premières analyses des performances d'un classifieur. Prenez un peu de temps pour analyser votre matrice de confusion et les métriques qui en découlent et répondez aux questions suivantes.")
```

```{r lda_qu}
quiz(
  question("Combien d'items du set de test sont correctement classé ?",
    answer(sprintf("%1.f", sum(conf_tab$TP)), correct = TRUE),
    answer(sprintf("%1.f", sum(conf_tab$Auto))),
    answer(sprintf("%1.f", conf_tab$Manu[1])),
    answer(sprintf("%1.f", conf_tab$TN[2])),
    answer("Aucune des réponses proposées"),
    allow_retry = TRUE,
    incorrect = "Mauvaise réponse. Recommencez afin de trouver la bonne réponse",
    correct = "Bravo, c'est correct !"),
  question("Quel est le taux d'erreur global (en %) ?",
    answer(sprintf("%.1f", 100 * (1 - (sum(conf_tab$TP)/sum(conf_tab$Auto)))), correct = TRUE),
    answer(sprintf("%.1f", 100 * (sum(conf_tab$TP)/sum(conf_tab$Auto)))),
  answer(sprintf("%3.f", sum(conf_tab$Auto) - sum(conf_tab$TP))),
    answer(sprintf("%3.f", conf_tab$TN[2])),
    answer("Aucune des réponses proposées"),
    allow_retry = TRUE,
    incorrect = "Mauvaise réponse. Recommencez afin de trouver la bonne réponse",
    correct = "Bravo, c'est correct !"),
  question("Quel est le taux de vrai positif pour les hommes (M) ?",
    answer(sprintf("%.3f", conf_tab[row.names(conf_tab) == "M", ]$Recall), correct = TRUE),
    answer(sprintf("%.3f", conf_tab[row.names(conf_tab) == "M", ]$Fscore)),
    answer(sprintf("%3.f", sum(conf_tab$Auto) - sum(conf_tab$TP))),
    answer(sprintf("%.3f", conf_tab[row.names(conf_tab) == "W", ]$Recall)),
    answer("Aucune des réponses proposées"),
    allow_retry = TRUE,
    incorrect = "Mauvaise réponse. Recommencez afin de trouver la bonne réponse",
    correct = "Bravo, c'est correct !")
  )
```

## Conclusion

```{r comm_noscore, echo=FALSE}
question_text(
  "Laissez-nous vos impressions sur cet outil pédagogique",
  answer("", TRUE, message = "Pas de commentaires... C'est bien aussi."),
  incorrect = "Vos commentaires sont enregistrés.",
  placeholder = "Entrez vos commentaires ici...",
  allow_retry = TRUE
)
```
